// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODÈLE: User (Utilisateurs)
// ============================================
model User {
  id             String    @id @default(uuid())
  email          String    @unique
  username       String    @unique // Pseudo unique
  passwordHash   String
  isAdmin        Boolean   @default(false)
  customCategories String? // JSON array de catégories personnalisées
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  sessions       Session[]
  notes          Note[]
  tasks          Task[]
  habits         Habit[]
  reminders      Reminder[]
  contacts       Contact[]
  contactRequestsSent ContactRequest[] @relation("RequesterContacts")
  contactRequestsReceived ContactRequest[] @relation("RecipientContacts")
  sharesOwned    Share[]   @relation("OwnerShares")
  sharesReceived Share[]   @relation("RecipientShares")
  publicShares   PublicShare[]
  subscription   Subscription?
}

// ============================================
// MODÈLE: Session (Sessions d'authentification)
// ============================================
model Session {
  token     String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// MODÈLE: Note (Notes)
// ============================================
model Note {
  id        String   @id @default(uuid())
  userId    String
  title     String
  text      String
  category  String   // "business" | "perso" | "sport" | "clients" | "urgent" | "autres"
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders Reminder[]
  shares Share[] @relation("NoteShares")
  publicShares PublicShare[]

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// MODÈLE: Task (Tâches)
// ============================================
model Task {
  id          String    @id @default(uuid())
  userId      String
  title       String
  description String?
  status      String    @default("pending") // "pending" | "completed" | "cancelled"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subTasks SubTask[]
  shares   Share[]  @relation("TaskShares")

  @@index([userId])
  @@index([status])
}

// ============================================
// MODÈLE: SubTask (Sous-tâches)
// ============================================
model SubTask {
  id        String   @id @default(uuid())
  taskId    String
  text      String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

// ============================================
// MODÈLE: Habit (Habitudes)
// ============================================
model Habit {
  id          String            @id @default(uuid())
  userId      String
  name        String
  description String?
  color       String?           @default("blue")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyRecords DailyHabitRecord[]
  shares       Share[]             @relation("HabitShares")

  @@index([userId])
}

// ============================================
// MODÈLE: DailyHabitRecord (Enregistrements quotidiens d'habitudes)
// ============================================
model DailyHabitRecord {
  id          String    @id @default(uuid())
  habitId     String
  date        String    // Format: YYYY-MM-DD
  status      String    @default("pending") // "completed" | "skipped" | "pending"
  completedAt DateTime?

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@index([habitId])
  @@index([date])
}

// ============================================
// MODÈLE: Reminder (Rappels)
// ============================================
model Reminder {
  id          String   @id @default(uuid())
  noteId      String
  userId      String
  userEmail   String
  noteTitle   String
  noteText    String
  reminderDate DateTime
  sent        Boolean  @default(false)
  createdAt   DateTime @default(now())

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reminderDate])
  @@index([sent])
}

// ============================================
// MODÈLE: Contact (Contacts)
// ============================================
model Contact {
  id              String   @id @default(uuid())
  userId          String   // Utilisateur qui a ajouté ce contact
  contactUserId   String   // ID de l'utilisateur contact
  contactUsername String   // Pseudo du contact (pour affichage rapide)
  contactEmail    String   // Email du contact (pour affichage)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contactUserId])
  @@index([userId])
  @@index([contactUserId])
}

// ============================================
// MODÈLE: ContactRequest (Demandes de contact)
// ============================================
model ContactRequest {
  id                String   @id @default(uuid())
  requesterId       String   // ID de l'utilisateur qui demande
  requesterUsername String   // Pseudo du demandeur
  requesterEmail    String   // Email du demandeur
  recipientId       String   // ID de l'utilisateur qui reçoit la demande
  status            String   @default("pending") // "pending" | "accepted" | "rejected"
  createdAt         DateTime @default(now())

  requester User @relation("RequesterContacts", fields: [requesterId], references: [id], onDelete: Cascade)
  recipient User @relation("RecipientContacts", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([requesterId, recipientId, status])
  @@index([requesterId])
  @@index([recipientId])
  @@index([status])
}

// ============================================
// MODÈLE: Share (Partages - Notes, Tâches, Habitudes, Rappels)
// ============================================
model Share {
  id           String   @id @default(uuid())
  ownerId      String   // Propriétaire
  sharedWithId String   // Utilisateur avec qui c'est partagé
  permission   String   @default("read") // "read" | "write"
  type         String   // "note" | "task" | "habit" | "reminder"
  noteId       String?  // Optionnel: ID de la note si type = "note"
  taskId       String?  // Optionnel: ID de la tâche si type = "task"
  habitId      String?  // Optionnel: ID de l'habitude si type = "habit"
  reminderId   String?  // Optionnel: ID du rappel si type = "reminder"
  createdAt    DateTime @default(now())

  owner      User  @relation("OwnerShares", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWith User  @relation("RecipientShares", fields: [sharedWithId], references: [id], onDelete: Cascade)
  note       Note? @relation("NoteShares", fields: [noteId], references: [id], onDelete: Cascade)
  task       Task? @relation("TaskShares", fields: [taskId], references: [id], onDelete: Cascade)
  habit      Habit? @relation("HabitShares", fields: [habitId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([sharedWithId])
  @@index([noteId])
  @@index([taskId])
  @@index([habitId])
  @@index([type])
}

// ============================================
// MODÈLE: PublicShare (Partages publics via lien)
// ============================================
model PublicShare {
  id         String    @id @default(uuid())
  noteId     String
  ownerId    String
  shareToken String    @unique
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([noteId])
  @@index([ownerId])
}

// ============================================
// MODÈLE: Subscription (Abonnements)
// ============================================
model Subscription {
  userId              String    @id
  plan                String    @default("free") // "free" | "pro" | "enterprise"
  startDate           DateTime  @default(now())
  endDate             DateTime? // null = actif indéfiniment
  stripeCustomerId    String?
  stripeSubscriptionId String?
  status              String    @default("active") // "active" | "canceled" | "past_due" | "trialing"
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}
